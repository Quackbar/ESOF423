<!DOCTYPE HTML>

<html>
	<head>
		<title>Profile</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<!--[if lte IE 8]><script src="assets/js/ie/html5shiv.js"></script><![endif]-->
		<link rel="stylesheet" href="assets/css/main.css" />
		<noscript><link rel="stylesheet" href="assets/css/noscript.css" /></noscript>
		<script src="https://www.gstatic.com/firebasejs/5.8.4/firebase.js"></script>

		<!--[if lte IE 9]><link rel="stylesheet" href="assets/css/ie9.css" /><![endif]-->
		<!--[if lte IE 8]><link rel="stylesheet" href="assets/css/ie8.css" /><![endif]-->
	</head>
	<body class="is-loading-0 is-loading-1">

		<!-- Wrapper -->
			<div id="wrapper">

				<!-- Home -->
					<article id="home" class="panel special">
						<div id=ppic class="image">
							<img src="images/default.jpg" alt="" data-position="center center" />
						</div>
						<div class="content">
							<div class="inner">
								<header>
									<h1><div id="fname"></div></h1>
									<p><div id="email">Email: </div><br />
									<div id="btype">Type: </div><br />
									<div id="userId">Age: </div><br />
									<div id="lname">Gender: </div></p>
								</header>
								<nav id="nav">
									<ul class="actions vertical special spinY">
										<li><a href="files.html" onclick="" class="button">Files</a></li>
										<li><a href="../search.html" onclick="" class="button">Search</a></li>

										<li><a href="https://esof-423.firebaseapp.com/update-info.html?" class="button">Update</a></li>
										<li><a href="../index.html" onclick="toggleSignIn()" class="button">Sign Out</a></li>
									</ul>
								</nav>
                            <div id="addFriend"></div>
							</div>
						</div>
					</article>
        <script>
          // Initialize Firebase
          var config = {
            apiKey: "AIzaSyDDsSMQ5fz__zVROPs58rqVnFlkcu15PF8",
            authDomain: "esof-423.firebaseapp.com",
            databaseURL: "https://esof-423.firebaseio.com",
            projectId: "esof-423",
            storageBucket: "esof-423.appspot.com",
            messagingSenderId: "991614948455"
          };
          firebase.initializeApp(config);
        </script>

      <script>
          var id="";
          
          function getUrlVars() {
              var vars = {};
              var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value) {
              vars[key] = value;
              });
              return vars;
          }
          
          firebase.auth().onAuthStateChanged(function(user) {
              if (user) {
                  id = user.uid;
              }
              else {
                  id=getUrlVars()["id"];
              }
          });
          
          function gotofiles() {
              window.location = 'files.html?id='+getUrlVars()["id"];
          }
          
          var url = "https://esof-423.firebaseio.com/users/"+getUrlVars()["id"]+"/";
          var fname = "username.json";
          var lname = "gender.json";
          var btype = "profile_type.json";
          var email = "email.json";
          var userId = "age.json";
          var ppic = "profile_picture.json";
      
          //Current user that is logged in
          //Change to string for developing
          //var currentUser = firebase.auth().currentUser.uid;
          var currentUser = "zSjdTDE9ZPefC9NmcvnYHzOI7U23";
          
          if(currentUser==getUrlVars()["id"]){
              //Viewing your Profile
              ppic= updateInfo(url +ppic, "ppic");
              fname= updateInfo(url + fname, "fname");
              lname= updateInfo(url +lname, "lname");
              btype= updateInfo(url +btype, "btype");
              email= updateInfo(url +email, "email");
              userId= updateInfo(url +userId, "userId");
          }
          else {
              //Viewing someone elses
              ppic= updateInfo(url +ppic, "ppic");
              fname= updateInfo(url + fname, "fname");
              
              //Hide Info we don't want people seeing
              document.getElementById("btype").style.display = "none";
              document.getElementById("email").style.display = "none";
              document.getElementById("userId").style.display = "none";
              document.getElementById("lname").style.display = "none";
              document.getElementById("nav").style.display = "none";
              
              //Add friend button goes here
              document.getElementById("addFriend").innerHTML = "<a href='' onclick='friendRequest()' class='button'>Add Friend</a>";
          }
          
          function friendRequest() {
              var friendId = getUrlVars()["id"];
              //var currentUser = firebase.auth().currentUser.uid;
              var currentUser = "zSjdTDE9ZPefC9NmcvnYHzOI7U23";
              var userRef = firebase.database().ref('users/'+friendId+"/friend_req").push({
                request: currentUser
              });
              
              
              //TODO: Send to DB
              
              
              alert("Friend Request Sent");
          }
          
          function updateInfo(value, id) {
              console.log(value);
              
              fetch(value)
                  .then(response => response.json())
                  .then(data => {
                      console.log(data);
                      if(data == null) {
                        document.getElementById(id).innerHTML = "";
                      }
                      else if(id == "ppic") {
                        document.getElementById(id).style = "background-image: url("+data+");";  
                      }
                      else {
                        document.getElementById(id).innerHTML = document.getElementById(id).innerHTML + data;
                      }

                      return data;
                  })
              .catch(err => {
                console.error('An error ocurred', err);
              })
          }
      </script>
		<!-- Scripts -->
			<script src="assets/js/jquery.min.js"></script>
			<script src="assets/js/skel.min.js"></script>
			<script src="assets/js/util.js"></script>
			<!--[if lte IE 8]><script src="assets/js/ie/respond.min.js"></script><![endif]-->
			<script src="assets/js/main.js"></script>

	</body>
</html>
