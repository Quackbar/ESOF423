<!DOCTYPE HTML>

<html>
	<head>
		<title>Profile</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<!--[if lte IE 8]><script src="assets/js/ie/html5shiv.js"></script><![endif]-->
		<link rel="stylesheet" href="assets/css/main.css"/>
		<noscript><link rel="stylesheet" href="assets/css/noscript.css" /></noscript>
		<script src="https://www.gstatic.com/firebasejs/5.8.4/firebase.js"></script>
        <script src='https://cdn.firebase.com/js/client/2.2.1/firebase.js'></script>
        <script src='https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js'></script>
        <script src="assets/js/jquery.min.js"></script>
        <link rel="sytlesheet" href="assets/css/requests.css" type="text/css"/>

		<!--[if lte IE 9]><link rel="stylesheet" href="assets/css/ie9.css" /><![endif]-->
		<!--[if lte IE 8]><link rel="stylesheet" href="assets/css/ie8.css" /><![endif]-->
	</head>
	<body class="is-loading-0 is-loading-1">
		<!-- Wrapper -->
			<div id="wrapper">

				<!-- Home -->
					<article id="home" class="panel special">
						<div id=ppic class="image">
							<img src="images/default.jpg" alt="" data-position="center center" />
						</div>
						<div class="content">
							<div class="inner">
								<header>
									<h1><div id="fname"></div></h1>
									<p><div id="email">Email: </div><br />
									<div id="btype">Type: </div><br />
									<div id="userId">Age: </div><br />
									<div id="lname">Gender: </div></p>
								</header>
								<nav id="nav">
									<ul class="actions vertical special spinY">
										<li><a href="files.html" onclick="" class="button">Files</a></li>
										<li><a href="../search.html" onclick="" class="button">Search</a></li>
										<li><a href="../forms/basicInfoForm.html" onclick="" class="button">Forms</a></li>
										<li><a href="https://esof-423.firebaseapp.com/update-info.html?" class="button">Update</a></li>
										<li><a href="../index.html" onclick="toggleSignIn()" class="button">Sign Out</a></li>
									</ul>
								</nav>
                            <div id="addFriend"></div>
                            <div id="recentReq"></div>
							</div>
						</div>
					</article>
        <script>
          // Initialize Firebase
          var config = {
            apiKey: "AIzaSyDDsSMQ5fz__zVROPs58rqVnFlkcu15PF8",
            authDomain: "esof-423.firebaseapp.com",
            databaseURL: "https://esof-423.firebaseio.com",
            projectId: "esof-423",
            storageBucket: "esof-423.appspot.com",
            messagingSenderId: "991614948455"
          };
          firebase.initializeApp(config);
            
            var counter = 0;

            function displayRequests(){
                var display = document.getElementById("recentReq");
                
                display.innerHTML = display.innerHTML + "<h4>Friend Requests</h4>";
                
                //var currentUser = firebase.auth().currentUser.uid;
                var userId = "PUJRmoguPDZ18AhGZy05vpM5gJM2";
                
                var ref = firebase.database().ref().child('users/'+userId+"/friend_req");

                // Get the most recent request
                ref.on("value", function(data) {
                    var requests = data.val();

                    ref.orderByChild("req").on("child_added", function(data) {
                        var reqRef = firebase.database().ref().child('users/'+data.val().req);


                        reqRef.on('value', function(snapshot) {
                            var output = "";
                            var role = "";

                            if(snapshot.val()!=null) {
                                var user_name = snapshot.val().username;
                                var role = snapshot.val().profile_type;
                                var id = snapshot.val().id;

                                output += "<div class='req'>";
                                output += "<p>"+user_name+"</p>";
                                output += "<p>"+role+"</p>";
                                output += '<button type="button" onclick="addFriend(\''+ id + '\')">Accept Friend Request</button>';
                                output += "</div>";
                            }
                            else {
                            }

                            display.innerHTML = display.innerHTML + output;
                        });
                    });
                });
            }
            
          var id="";

          function getUrlVars() {
              var vars = {};
              var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value) {
              vars[key] = value;
              });
              return vars;
          }

          firebase.auth().onAuthStateChanged(function(user) {
              if (user) {
                  id = user.uid;
              }
              else {
                  id=getUrlVars()["id"];
              }
          });

          function gotofiles() {
              window.location = 'files.html?id='+getUrlVars()["id"];
          }

          var url = "https://esof-423.firebaseio.com/users/"+getUrlVars()["id"]+"/";
          var fname = "username.json";
          var lname = "gender.json";
          var btype = "profile_type.json";
          var email = "email.json";
          var userId = "age.json";
          var ppic = "profile_picture.json";

          //Current user that is logged in
          //Change to string for developing
          //var currentUser = firebase.auth().currentUser.uid;
          var currentUser = "zSjdTDE9ZPefC9NmcvnYHzOI7U23";

          if(currentUser==getUrlVars()["id"]){
              //Viewing your Profile
              ppic= updateInfo(url +ppic, "ppic");
              fname= updateInfo(url + fname, "fname");
              lname= updateInfo(url +lname, "lname");
              btype= updateInfo(url +btype, "btype");
              email= updateInfo(url +email, "email");
              userId= updateInfo(url +userId, "userId");
              
              displayRequests();
          }
          else {
              //Viewing someone elses
              ppic= updateInfo(url +ppic, "ppic");
              fname= updateInfo(url + fname, "fname");

              //Hide Info we don't want people seeing
              document.getElementById("btype").style.display = "none";
              document.getElementById("email").style.display = "none";
              document.getElementById("userId").style.display = "none";
              document.getElementById("lname").style.display = "none";
              document.getElementById("nav").style.display = "none";

              //Add friend button goes here
              document.getElementById("addFriend").innerHTML = "<a href='' onclick='friendRequest()' class='button'>Add Friend</a>";
          }

          function friendRequest() {
              var friendId = getUrlVars()["id"];
              //var currentUser = firebase.auth().currentUser.uid;
              var currentUser = "PUJRmoguPDZ18AhGZy05vpM5gJM2";
              var userRef = firebase.database().ref().child('users/'+friendId+"/friend_req");

              var newReq = userRef.push();
              
              newReq.set ({
                  req: currentUser
              });

              alert("Friend Request Sent");
          }
            function addFriend(reqId) {
                var currentUser = getUrlVars()["id"];
                var userRef = firebase.database().ref().child('users/'+currentUser+"/friend_list");
                var friendRef = firebase.database().ref().child('users/'+reqId+"/friend_list");
                /*
                var newReq = friendRef.push();
              
                newReq.set ({
                    friend: currentUser
                });
                
                var newReq2 = userRef.push();
              
                newReq2.set ({
                    friend: reqId
                });
                */
                
                deleteReq(reqId,currentUser);
                
                alert("You are now friends");
            }
            
            function deleteReq(reqId,userId) {
                var ref = firebase.database().ref().child('users/'+userId+"/friend_req");

                // Get the most recent request
                ref.on("value", function(data) {
                    var requests = data.val();

                    ref.orderByChild("req").equalTo(reqId).on("child_added", function(data) {
                        console.log(data.val());
                        
                        ref.remove();
                    });
                });
                
            }
          function updateInfo(value, id) {
              console.log(value);

              fetch(value)
                  .then(response => response.json())
                  .then(data => {
                      console.log(data);
                      if(data == null) {
                        document.getElementById(id).innerHTML = "";
                      }
                      else if(id == "ppic") {
                        document.getElementById(id).style = "background-image: url("+data+");";
                      }
                      else {
                        document.getElementById(id).innerHTML = document.getElementById(id).innerHTML + data;
                      }

                      return data;
                  })
              .catch(err => {
                console.error('An error ocurred', err);
              })
          }
      </script>
		<!-- Scripts -->
			<script src="assets/js/skel.min.js"></script>
			<script src="assets/js/util.js"></script>
			<!--[if lte IE 8]><script src="assets/js/ie/respond.min.js"></script><![endif]-->
			<script src="assets/js/main.js"></script>

	</body>
</html>